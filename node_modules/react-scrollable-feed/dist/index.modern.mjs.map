{"version":3,"file":"index.modern.mjs","sources":["../src/index.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { CSSProperties } from 'react';\r\n\r\nexport type ScrollableFeedProps = {\r\n    forceScroll?: boolean;\r\n    animateScroll?: (element: HTMLElement, offset: number) => void;\r\n    onScrollComplete?: () => void;\r\n    changeDetectionFilter?: (previousProps: ScrollableFeedComponentProps, newProps: ScrollableFeedComponentProps) => boolean;\r\n    viewableDetectionEpsilon?: number;\r\n    className?: string;\r\n    onScroll?: (isAtBottom: boolean) => void;\r\n    debug?: boolean\r\n}\r\n\r\ntype ScrollableFeedComponentProps = React.PropsWithChildren<ScrollableFeedProps>;\r\n\r\nclass ScrollableFeed extends React.Component<React.PropsWithChildren<ScrollableFeedProps>> {\r\n    private readonly wrapperRef: React.RefObject<HTMLDivElement>;\r\n    private readonly bottomRef: React.RefObject<HTMLDivElement>;\r\n\r\n    constructor(props: ScrollableFeedProps) {\r\n        super(props);\r\n        this.bottomRef = React.createRef();\r\n        this.wrapperRef = React.createRef();\r\n        this.handleScroll = this.handleScroll.bind(this);\r\n\r\n        if (this.props.debug) console.log(\"Component cstr\");\r\n    }\r\n\r\n    static defaultProps: ScrollableFeedProps = {\r\n        forceScroll: false,\r\n        animateScroll: (element: HTMLElement, offset: number): void => {\r\n            if (element.scrollBy) {\r\n                element.scrollBy({ top: offset });\r\n            }\r\n            else {\r\n                element.scrollTop = offset;\r\n            }\r\n        },\r\n        onScrollComplete: () => {},\r\n        changeDetectionFilter: () => true,\r\n        viewableDetectionEpsilon: 2,\r\n        onScroll: () => {},\r\n    };\r\n\r\n    getSnapshotBeforeUpdate(): boolean {\r\n        if (this.props.debug) console.log(\"Component \", this.getSnapshotBeforeUpdate.name);\r\n        if (this.wrapperRef.current && this.bottomRef.current) {\r\n            const { viewableDetectionEpsilon } = this.props;\r\n            return ScrollableFeed.isViewable(this.wrapperRef.current, this.bottomRef.current, viewableDetectionEpsilon!); //This argument is passed down to componentDidUpdate as 3rd parameter\r\n        }\r\n        return false;\r\n    }\r\n\r\n    componentDidUpdate(previousProps: ScrollableFeedComponentProps, _previousState: any, snapshot: boolean): void {\r\n        if (this.props.debug) console.log(\"Component \", this.componentDidUpdate.name);\r\n        const { forceScroll, changeDetectionFilter } = this.props;\r\n        const isValidChange = changeDetectionFilter!(previousProps, this.props);\r\n        if (isValidChange && (forceScroll || snapshot) && this.bottomRef.current && this.wrapperRef.current) {\r\n            this.scrollParentToChild(this.wrapperRef.current, this.bottomRef.current);\r\n        }\r\n    }\r\n\r\n    componentDidMount(): void {\r\n        if (this.props.debug) console.log(\"Component \", this.componentDidMount.name);\r\n        //Scroll to bottom from the start\r\n        if (this.bottomRef.current && this.wrapperRef.current) {\r\n            this.scrollParentToChild(this.wrapperRef.current, this.bottomRef.current);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Scrolls a parent element such that the child element will be in view\r\n     * @param parent\r\n     * @param child\r\n     */\r\n    protected scrollParentToChild(parent: HTMLElement, child: HTMLElement): void {\r\n        const { viewableDetectionEpsilon } = this.props;\r\n        if (!ScrollableFeed.isViewable(parent, child, viewableDetectionEpsilon!)) {\r\n            //Source: https://stackoverflow.com/a/45411081/6316091\r\n            const parentRect = parent.getBoundingClientRect();\r\n            const childRect = child.getBoundingClientRect();\r\n\r\n            //Scroll by offset relative to parent\r\n            const scrollOffset = (childRect.top + parent.scrollTop) - parentRect.top;\r\n            const { animateScroll, onScrollComplete } = this.props;\r\n            if (animateScroll) {\r\n                animateScroll(parent, scrollOffset);\r\n                onScrollComplete!();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns whether a child element is visible within a parent element\r\n     *\r\n     * @param parent\r\n     * @param child\r\n     * @param epsilon\r\n     */\r\n    private static isViewable(parent: HTMLElement, child: HTMLElement, epsilon: number): boolean {\r\n        epsilon = epsilon || 0;\r\n\r\n        //Source: https://stackoverflow.com/a/45411081/6316091\r\n        const parentRect = parent.getBoundingClientRect();\r\n        const childRect = child.getBoundingClientRect();\r\n\r\n        const childTopIsViewable = (childRect.top >= parentRect.top);\r\n\r\n        const childOffsetToParentBottom = parentRect.top + parent.clientHeight - childRect.top;\r\n        const childBottomIsViewable = childOffsetToParentBottom + epsilon >= 0;\r\n\r\n        return childTopIsViewable && childBottomIsViewable;\r\n    }\r\n\r\n    /**\r\n     * Fires the onScroll event, sending isAtBottom boolean as its first parameter\r\n     */\r\n    protected handleScroll(): void {\r\n        const { viewableDetectionEpsilon, onScroll } = this.props;\r\n        if (onScroll && this.bottomRef.current && this.wrapperRef.current) {\r\n            const isAtBottom = ScrollableFeed.isViewable(this.wrapperRef.current, this.bottomRef.current, viewableDetectionEpsilon!);\r\n            onScroll(isAtBottom);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Scroll to the bottom\r\n     */\r\n    public scrollToBottom(): void {\r\n        if (this.bottomRef.current && this.wrapperRef.current) {\r\n            this.scrollParentToChild(this.wrapperRef.current, this.bottomRef.current);\r\n        }\r\n    }\r\n\r\n    render(): React.ReactNode {\r\n        if (this.props.debug) console.log(\"Component \", this.render.name);\r\n\r\n        const style: CSSProperties = {\r\n            maxHeight: \"inherit\",\r\n            height: \"inherit\",\r\n            overflowY: \"auto\",\r\n        };\r\n        const { children, className } = this.props;\r\n        return (\r\n            <div className={className} style={style} ref={this.wrapperRef} onScroll={this.handleScroll}>\r\n                {children}\r\n                <div ref={this.bottomRef}></div>\r\n            </div>\r\n        );\r\n    }\r\n}\r\n\r\nexport default ScrollableFeed;\r\n"],"names":["ScrollableFeed","React","Component","constructor","props","super","this","wrapperRef","bottomRef","createRef","handleScroll","bind","debug","console","log","getSnapshotBeforeUpdate","name","current","viewableDetectionEpsilon","isViewable","componentDidUpdate","previousProps","_previousState","snapshot","forceScroll","changeDetectionFilter","scrollParentToChild","componentDidMount","parent","child","parentRect","getBoundingClientRect","scrollOffset","top","scrollTop","animateScroll","onScrollComplete","epsilon","childRect","clientHeight","onScroll","scrollToBottom","render","children","className","style","maxHeight","height","overflowY","ref","createElement","defaultProps","element","offset","scrollBy"],"mappings":"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"}